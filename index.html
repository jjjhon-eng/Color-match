<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1,
                 user-scalable=no, viewport-fit=cover" />
  <title>顏色配對（穩定版）</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --border:#e9ecf4; --muted:#667085;
      --vh: 100svh; /* 由 JS 以 visualViewport.height 覆蓋 */
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

    /* 完全鎖定頁面與高度 */
    html, body{
      margin:0; padding:0;
      overflow:hidden;               /* 無捲軸 */
      overscroll-behavior:none;      /* 無回彈 */
      -webkit-text-size-adjust:100%;
      height:100dvh;                 /* 新版瀏覽器穩定視口 */
      height:var(--vh);              /* 舊版以 JS 值為準 */
    }
    body{
      background:var(--bg); color:#222;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Microsoft JhengHei",
                   "Segoe UI",Roboto,Arial,sans-serif;
      display:flex; align-items:center; justify-content:center;
      position:fixed; inset:0;       /* iOS 防橡皮筋 */
      touch-action:none;             /* 禁觸控捲動 */
      -webkit-user-select:none; user-select:none;
      transform: translateZ(0); backface-visibility:hidden;
    }

    .app{
      width:min(720px,95vw);
      background:var(--card);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      padding:20px;
      text-align:center;
      transform: translateZ(0); backface-visibility:hidden;
    }

    h1{ margin:8px 0 10px; }
    .stats{ display:flex; justify-content:space-around; margin:8px 0 16px; }
    .pill{ background:#eef1f6; padding:8px 14px; border-radius:999px; font-weight:700; }

    .card{
      border:2px solid var(--border); border-radius:14px;
      padding:28px 16px; margin:10px 0 16px;
      min-height:120px;              /* 固定內容區高度，避免跳動 */
      display:flex; align-items:center; justify-content:center;
    }
    #word{ font-size:48px; font-weight:800; line-height:1; }

    .btns{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
    button{
      flex:1 1 40%;
      border:0; border-radius:12px; padding:14px 16px;
      font-size:18px; font-weight:800; cursor:pointer;
      outline:none;
      transform: translateZ(0);
    }
    .yes{ background:#e9f7ed; color:#0a7a3f; }
    .no { background:#ffe9e9; color:#b00020; }
    .start{ background:#1a73e8; color:#fff; width:100%; margin-top:12px; }
    .stop { background:#b00020; color:#fff; width:100%; margin-top:8px; display:none; }
    .tip{ margin-top:10px; color:var(--muted); font-size:14px; }
    .disabled{ opacity:.5; pointer-events:none; }
  </style>
</head>
<body>
  <div class="app">
    <h1>顏色配對（穩定版）</h1>
    <div class="stats">
      <div class="pill">時間：<span id="time">60</span>s</div>
      <div class="pill">分數：<span id="score">0</span></div>
      <div class="pill">回合：<span id="round">0</span></div>
    </div>

    <div class="card">
      <div id="word">點「開始遊戲」吧！</div>
    </div>

    <div class="btns">
      <button class="yes disabled" id="btnYes">一致</button>
      <button class="no  disabled" id="btnNo">不一致</button>
    </div>

    <button class="start" id="btnStart">開始遊戲</button>
    <button class="stop"  id="btnStop">停止（取消本局）</button>
    <div class="tip">規則：系統盡量保持「對/錯 50% : 50%」。答對 +10、答錯 −10。計時 60 秒。</div>
  </div>

<script>
  /* 0) 用 visualViewport 鎖住實際高度，避免地址欄收起/展開抖動 */
  function setVH(){
    const vv = window.visualViewport;
    const h = vv ? Math.round(vv.height) : Math.max(window.innerHeight, document.documentElement.clientHeight);
    document.documentElement.style.setProperty('--vh', h + 'px');
    window.scrollTo(0,0);
  }
  setVH();
  window.addEventListener('resize', setVH);
  window.addEventListener('orientationchange', setVH);
  if (window.visualViewport) {
    visualViewport.addEventListener('resize', setVH);
    visualViewport.addEventListener('scroll', setVH);
  }

  /* 1) 顏色資料（不含黃色） */
  const WORDS = ['紅色','藍色','綠色','黑色','紫色','橙色'];
  const keyFromText = { '紅色':'red','藍色':'blue','綠色':'green','黑色':'black','紫色':'purple','橙色':'orange' };
  const colorKeys = Object.values(keyFromText);
  const cssMap = { red:'red', blue:'royalblue', green:'seagreen', black:'#111', purple:'rebeccapurple', orange:'orange' };

  /* 2) 狀態 */
  let running=false, score=0, round=0, timeLeft=60, timer=null;
  let correctAnswer=null, matchCount=0, mismatchCount=0;

  /* 3) DOM */
  const wordEl  = document.getElementById('word');
  const timeEl  = document.getElementById('time');
  const scoreEl = document.getElementById('score');
  const roundEl = document.getElementById('round');
  const btnYes  = document.getElementById('btnYes');
  const btnNo   = document.getElementById('btnNo');
  const btnStart= document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');

  const rand = arr => arr[Math.floor(Math.random()*arr.length)];
  const revMap = Object.fromEntries(Object.entries(keyFromText).map(([cn,en]) => [en, cn]));
  const enablePlay = en => [btnYes, btnNo].forEach(b => b.classList.toggle('disabled', !en));

  /* 4) 50/50 決策 */
  function nextShouldMatch(){
    if (matchCount > mismatchCount) return false;
    if (mismatchCount > matchCount) return true;
    return Math.random() < 0.5;
  }

  function newRound(){
    const shouldMatch = nextShouldMatch();
    let word, colorKey;
    if (shouldMatch){
      colorKey = rand(colorKeys);
      word = revMap[colorKey];
      correctAnswer = true;
      matchCount++;
    } else {
      word = rand(WORDS);
      const correctKey = keyFromText[word];
      colorKey = rand(colorKeys.filter(k => k !== correctKey));
      correctAnswer = false;
      mismatchCount++;
    }
    wordEl.textContent = word;
    wordEl.style.color = cssMap[colorKey] || colorKey;
    round += 1; roundEl.textContent = round;
  }

  function toIdle(message='點「開始遊戲」吧！'){
    running=false; clearInterval(timer); enablePlay(false);
    btnStart.disabled=false; btnStart.textContent='開始遊戲';
    btnStop.style.display='none';
    wordEl.textContent = message; wordEl.style.color = '#222';
  }

  function startGame(){
    if(running) return;
    running = true; score=0; round=0; timeLeft=60; matchCount=0; mismatchCount=0;
    scoreEl.textContent = score; roundEl.textContent = round; timeEl.textContent = timeLeft;
    btnStart.textContent = '進行中…'; btnStart.disabled = true; enablePlay(true);
    btnStop.style.display='block';
    newRound();
    clearInterval(timer);
    timer = setInterval(()=>{
      timeLeft -= 1; timeEl.textContent = timeLeft;
      if(timeLeft<=0) endGame();
    }, 1000);
  }

  function endGame(){
    toIdle(`時間到！最終分數：${score}`);
  }

  function stopGame(){
    toIdle('本局已停止。');
  }

  function answer(isMatch){
    if(!running) return;
    if(isMatch === !!correctAnswer) score += 10; else score -= 10;
    scoreEl.textContent = score;
    newRound();
  }

  btnStart.addEventListener('click', startGame);
  btnStop .addEventListener('click', stopGame);
  btnYes  .addEventListener('click', () => answer(true));
  btnNo   .addEventListener('click', () => answer(false));

  /* 5) 防縮放 + 防滾動（多重保險） */
  let lastTouchEnd = 0;
  document.addEventListener('touchend', e => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) e.preventDefault();  // 禁雙擊放大
    lastTouchEnd = now;
  }, {passive:false});
  document.addEventListener('dblclick', e => e.preventDefault(), {passive:false});
  document.addEventListener('gesturestart', e => e.preventDefault()); // 禁兩指縮放

  window.scrollTo(0,0);
  window.addEventListener('scroll', () => window.scrollTo(0,0), {passive:false});
  document.addEventListener('touchmove', e => e.preventDefault(), {passive:false});
</script>
</body>
</html>
